<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å¿«é€Ÿæƒæå™¨ - å„ªåŒ–å°ç„¦ç‰ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            text-align: center;
            padding: 10px;
            background-color: #f8f9fa;
        }
        h2 { color: #333; }
        #reader {
            width: 100%;
            max-width: 450px;
            margin: 15px auto;
            border-radius: 8px;
            overflow: hidden;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .controls {
            margin-bottom: 20px;
        }
        button {
            font-size: 16px;
            font-weight: bold;
            padding: 12px 24px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:active { background-color: #0056b3; }
        
        table {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            border-collapse: collapse;
            background: white;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 10px;
            word-break: break-all;
        }
        th { background-color: #e9ecef; }
    </style>
</head>
<body>

<h2>ğŸ“· å¿«é€Ÿæƒæå™¨</h2>

<div class="controls">
    <button id="startBtn">å•Ÿå‹•æƒææ§</button>
</div>

<div id="reader"></div>

<table>
    <thead>
        <tr>
            <th>#</th>
            <th>å…§å®¹</th>
            <th>é¡å‹</th>
            <th>æ™‚é–“</th>
        </tr>
    </thead>
    <tbody id="resultTable"></tbody>
</table>

<script>
    let html5QrCode;
    let isScanning = false;
    let count = 0;

    const startBtn = document.getElementById("startBtn");
    const resultTable = document.getElementById("resultTable");
    const readerDiv = document.getElementById("reader");

    startBtn.addEventListener("click", async () => {
        if (isScanning) return;

        isScanning = true;
        readerDiv.style.display = "block";
        startBtn.innerText = "æ­£åœ¨æƒæ...";
        startBtn.style.backgroundColor = "#6c757d";

        html5QrCode = new Html5Qrcode("reader");

        // å„ªåŒ–è¨­å®šï¼šæé«˜ FPS ä¸¦å„ªåŒ–åµæ¸¬æ¡†
        const config = {
            fps: 20,           // ğŸš€ æé«˜åˆ° 20 FPS (åæ‡‰æ›´å³æ™‚)
            qrbox: (viewfinderWidth, viewfinderHeight) => {
                // ğŸš€ å‹•æ…‹åµæ¸¬æ¡†ï¼šé‡å°æ¢ç¢¼èª¿æ•´ç‚ºé•·æ–¹å½¢ï¼Œæ¸›å°‘æ¼”ç®—æ³•é‹ç®—é¢ç©
                const width = viewfinderWidth * 0.7;
                const height = viewfinderHeight * 0.3; 
                return { width: width, height: height };
            },
            aspectRatio: 1.0,  // å¼·åˆ¶ 1:1 æˆ–éš¨è¢å¹•èª¿æ•´
            experimentalFeatures: {
                useBarCodeDetectorIfSupported: true // ğŸš€ é—œéµï¼šé–‹å•Ÿæ‰‹æ©ŸåŸç”Ÿç¡¬é«”åŠ é€Ÿ
            }
        };

        try {
            await html5QrCode.start(
                { facingMode: "environment" }, // å¼·åˆ¶å¾Œç½®é¡é ­
                config,
                async (decodedText, decodedResult) => {
                    count++;
                    
                    // æ–°å¢çµæœåˆ°è¡¨æ ¼
                    const row = `
                        <tr>
                            <td>${count}</td>
                            <td><strong>${decodedText}</strong></td>
                            <td>${decodedResult.result.format.formatName}</td>
                            <td>${new Date().toLocaleTimeString()}</td>
                        </tr>
                    `;
                    resultTable.insertAdjacentHTML("afterbegin", row); // æ–°çš„åœ¨æœ€ä¸Šé¢

                    // æˆåŠŸå¾Œç«‹å³åœæ­¢ä»¥ç¯€çœè³‡æº
                    stopScanning();
                },
                (errorMessage) => {
                    // å¿½ç•¥åµæ¸¬ä¸­çš„éŒ¯èª¤è¨Šæ¯ä»¥æå‡æ•ˆèƒ½
                }
            );
        } catch (err) {
            console.error(err);
            alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿã€‚è«‹ç¢ºä¿ï¼š\n1. ä½¿ç”¨ HTTPS é€£ç·š\n2. å·²æˆæ¬Šç›¸æ©Ÿå­˜å–");
            stopScanning();
        }
    });

    async function stopScanning() {
        if (html5QrCode && html5QrCode.isScanning) {
            await html5QrCode.stop();
            html5QrCode.clear();
        }
        isScanning = false;
        readerDiv.style.display = "none";
        startBtn.innerText = "å•Ÿå‹•æƒææ§";
        startBtn.style.backgroundColor = "#007bff";
    }
</script>

</body>
</html>